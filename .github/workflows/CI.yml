name: CI

on:
  pull_request:
    types: [opened, synchronize]
    branches: [develop, release/**, fleety_*]

permissions: read-all

concurrency:
  group: ${{ github.event.pull_request.number }}-${{ github.workflow }}
  cancel-in-progress: true

env:
  PR_ID: ${{ github.event.pull_request.number }}
  COMMIT_ID: ${{ github.event.pull_request.head.sha }}

jobs:
  clone:
    name: Clone-linux
    uses: ./.github/workflows/_Clone-linux.yml
    with:
      workflow-name: 'CI'

  build-docker:
    name: build docker images
    needs: clone
    uses: ./.github/workflows/docker.yml

  sot:
    name: PR-CI-SOT
    uses: ./.github/workflows/_SOT.yml
    needs: [clone, build-docker]
    with:
      docker_cpu_image: ${{ needs.build-docker.outputs.docker_cpu_image }}
      clone-can-skip: ${{ needs.clone.outputs.can-skip }}

  mac:
    name: Mac-CPU
    uses: ./.github/workflows/_Mac.yml
    needs: clone
    with:
      clone-can-skip: ${{ needs.clone.outputs.can-skip }}

  xpu:
    name: Linux-XPU
    uses: ./.github/workflows/_Linux-XPU.yml
    needs: [clone, build-docker]
    with:
      docker_xpu_image: ${{ needs.build-docker.outputs.docker_xpu_image }}
      clone-can-skip: ${{ needs.clone.outputs.can-skip }}

  dcu:
    name: Linux-DCU
    uses: ./.github/workflows/_Linux-DCU.yml
    needs: [clone, build-docker]
    with:
      docker_dcu_image: ${{ needs.build-docker.outputs.docker_dcu_image }}
      clone-can-skip: ${{ needs.clone.outputs.can-skip }}

  cpu:
    name: Linux-CPU
    uses: ./.github/workflows/_Linux-CPU.yml
    needs: [clone, build-docker]
    with:
      docker_cpu_image: ${{ needs.build-docker.outputs.docker_cpu_image }}

  npu:
    name: Linux-NPU
    uses: ./.github/workflows/_Linux-NPU.yml
    needs: [clone, cpu, build-docker]
    with:
      can-skip: ${{ needs.cpu.outputs.can-skip }}
      docker_npu_image: ${{ needs.build-docker.outputs.docker_npu_image }}

  distribute:
    name: Distribute-stable
    uses: ./.github/workflows/_Distribute-stable.yml
    needs: [clone, build-docker]
    with:
      docker_distribute_image: ${{ needs.build-docker.outputs.docker_distribute_image }}
      clone-can-skip: ${{ needs.clone.outputs.can-skip }}
